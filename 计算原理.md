# Fabry-Pérot腔OAM模式分析软件计算原理

## 1. 基本概念

### 1.1 Fabry-Pérot腔简介

Fabry-Pérot(FP)腔是一种由两个平行或曲面反射镜组成的光学谐振腔。当光束进入腔体后，会在两个反射镜之间进行多次反射，形成驻波。只有当入射光的波长满足特定条件时，才会产生共振，使光波相长干涉，从而大幅提高透射率。

FP腔广泛应用于激光器、光谱分析、传感器和量子光学等领域。在本软件中，我们特别关注FP腔对不同轨道角动量(OAM)模式的透射特性。

### 1.2 轨道角动量(OAM)模式

轨道角动量是光的一种本征特性，与光的螺旋相位分布有关。具有OAM的光束，其波前呈螺旋状，相位围绕传播轴旋转2πl（l为整数，称为拓扑荷）。不同的l值对应不同的OAM模式。

OAM模式通常表示为Laguerre-Gaussian(LG)模式，其电场分布为：

$$E(r,\theta,z) \propto \left(\frac{r}{w_0}\right)^{|l|} L_p^{|l|}\left(\frac{2r^2}{w_0^2}\right) \exp\left(-\frac{r^2}{w_0^2}\right) \exp(il\theta)$$

其中：
- $l$ 是拓扑荷（OAM量子数）
- $p$ 是径向模式指数
- $L_p^{|l|}$ 是广义拉盖尔多项式
- $w_0$ 是基模束腰半径
- $r, \theta$ 是极坐标

## 2. 物理量计算

### 2.1 自由光谱范围(FSR)

FSR是指腔内相邻共振模式之间的频率间隔，公式为：

$$\text{FSR} = \frac{c}{2nL}$$

其中：
- $c$ 是光速
- $n$ 是介质折射率（空气中约为1）
- $L$ 是腔长

代码实现：
```python
fsr = c / (2 * n * base_cavity_length)
```

### 2.2 精细度(Finesse)

精细度描述腔的频率选择能力，由腔内反射镜的反射率决定：

$$\mathcal{F} = \frac{\pi \sqrt{R_1 R_2}}{1 - \sqrt{R_1 R_2}}$$

其中：
- $R_1, R_2$ 是两个镜面的反射率

代码实现：
```python
r1 = np.sqrt(reflectivity1)
r2 = np.sqrt(reflectivity2)
finesse = np.pi * np.sqrt(r1 * r2) / (1 - r1 * r2)
```

### 2.3 基模束腰半径

束腰半径决定了光束在腔内的横向尺寸，计算公式为：

$$w_0^2 = \frac{L\lambda}{\pi} \sqrt{\frac{g_1g_2(1-g_1g_2)}{(g_1+g_2-2g_1g_2)^2}}$$

其中：
- $\lambda$ 是光的波长
- $g_1 = 1-\frac{L}{R_1}$, $g_2 = 1-\frac{L}{R_2}$ 是腔的稳定性参数
- $R_1, R_2$ 是两个镜面的曲率半径

代码实现：
```python
g1 = 1 - base_cavity_length / radius1
g2 = 1 - base_cavity_length / radius2

if (g1 + g2 - 2*g1*g2) == 0:  # 避免除零
    beam_waist = np.sqrt((base_cavity_length * wavelength) / np.pi)
else:
    beam_waist = np.sqrt((wavelength * base_cavity_length) / np.pi) * \
                np.sqrt(g1*g2*(1-g1*g2) / ((g1+g2-2*g1*g2)**2))
```

### 2.4 模式间距与线宽

模式间距是FSR除以精细度：
$$\Delta \nu = \frac{\text{FSR}}{\mathcal{F}}$$

线宽与模式间距和波长相关：
$$\Delta \lambda = \frac{\lambda^2}{c} \cdot \Delta \nu$$

代码实现：
```python
mode_spacing = fsr / finesse
linewidth = (wavelength**2 / c) * mode_spacing
```

## 3. 透射率计算

### 3.1 透射率公式

FP腔的透射率计算公式为：

$$T = \frac{T_1 T_2}{(1 - \sqrt{R_1 R_2})^2 + 4\sqrt{R_1 R_2} \sin^2 \frac{\delta}{2}}$$

其中：
- $T_1 = 1-R_1$, $T_2 = 1-R_2$ 是两个镜面的透射率
- $\delta$ 是单程相位差

### 3.2 相位差计算

相位差包含腔长和模式的贡献：

$$\delta = \frac{4\pi}{\lambda}nL + 2(2p + |l| + 1)\phi$$

其中：
- $\phi = \arccos(\pm\sqrt{g_1 g_2})$ 是Gouy相位
- 符号由腔的稳定性决定，当 $g_1g_2 \geq 0$ 时取正号

代码实现：
```python
if g1*g2 >= 0:
    phi = np.arccos(np.sqrt(g1*g2))
else:
    phi = np.arccos(-np.sqrt(abs(g1*g2)))

p = 0  # 默认径向模式为0
delta = (4*np.pi/wavelength) * n * cavity_length + 2*(2*p + abs(l) + 1) * phi

# 计算透射率
numerator = t1 * t2
denominator = (1 - np.sqrt(reflectivity1 * reflectivity2))**2 + \
            4 * np.sqrt(reflectivity1 * reflectivity2) * (np.sin(delta/2))**2
transmission = numerator / denominator
```

## 4. 理论可分辨最大模式数计算

理论可分辨最大模式数表示在给定腔参数下，腔能够分辨的最大OAM模式数量。本软件使用了综合多指标的科学评估方法。

### 4.1 基本原理

评估模式可分辨性依据以下三个主要标准：

1. **峰值重叠度**：衡量两个模式透射率曲线的重叠程度
2. **峰值分离度**：基于莱利判据评估相邻峰是否可分辨
3. **峰值对比度**：评估峰值强度的相对差异

### 4.2 峰值检测与精确估计

#### 4.2.1 初步峰值检测

首先对每个OAM模式的透射率曲线执行初步峰值检测：

```python
peaks, properties = find_peaks(self.transmissions[l], height=0.3, prominence=0.05)
```

我们使用较低的峰值阈值(0.3)并加入显著性(prominence)参数，以便可靠地检测关键峰值。

#### 4.2.2 峰值插值估计

对于高反射率FP腔（如R > 0.99），由于共振峰极其尖锐，计算网格的离散采样可能导致真实峰值的丢失。因此，我们采用插值估计方法来精确定位峰值：

```python
def estimate_true_peak(self, x_values, y_values, peak_idx):
    # 选取峰值周围的点进行拟合
    window = 3  # 左右各3个点
    start_idx = max(0, peak_idx - window)
    end_idx = min(len(y_values), peak_idx + window + 1)
    
    # 提取用于拟合的数据点
    x_fit = x_values[start_idx:end_idx]
    y_fit = y_values[start_idx:end_idx]
    
    # 使用洛伦兹函数拟合FP腔的共振峰
    def lorentzian(x, amplitude, x0, gamma):
        return amplitude * gamma**2 / ((x - x0)**2 + gamma**2)
    
    # 执行曲线拟合
    initial_guess = [y_values[peak_idx], x_values[peak_idx], 
                   (x_values[end_idx-1] - x_values[start_idx])/4]
    popt, _ = curve_fit(lorentzian, x_fit, y_fit, p0=initial_guess)
    
    # 返回拟合的真实峰值和位置
    return popt[0], popt[1]  # 振幅、位置
```

这种方法的优点是：

1. **高精度**：通过对峰值附近点的曲线拟合，可以获得亚像素级精度的峰值位置和高度
2. **物理合理性**：使用洛伦兹(Lorentzian)函数拟合，这是描述FP腔共振峰的理论模型
3. **计算效率**：只对检测到的峰值进行插值计算，而不是整条曲线，保持计算效率

### 4.3 峰值重叠度计算

重叠度计算基于两条曲线的交叉点：

```python
def calculate_curve_overlap(self, mode1, mode2):
    # 计算每个交叉点的重叠度，找出最大值
    transmission1 = self.transmissions[mode1]
    transmission2 = self.transmissions[mode2]
    
    # 寻找交叉点位置
    crossings = []
    for i in range(1, len(transmission1)):
        if ((transmission1[i-1] - transmission2[i-1]) * 
            (transmission1[i] - transmission2[i])) <= 0:
            crossings.append(i)
    
    # 计算交叉点处的最大重叠度
    max_overlap = 0
    for crossing in crossings:
        transmission_at_crossing = (transmission1[crossing] + transmission2[crossing]) / 2
        max_overlap = max(max_overlap, transmission_at_crossing)
        
    return max_overlap
```

### 4.4 莱利判据应用

根据莱利判据，当两个峰值的间距大于线宽的一定比例时，认为这两个峰值可以分辨。但现在我们使用精确估计的峰值位置：

```python
# 使用精确计算的峰值位置
if accurate_peak_positions[i] and accurate_peak_positions[j]:
    # 找到两个模式最近的峰值对
    min_peak_distance = float('inf')
    for pos_i in accurate_peak_positions[i]:
        for pos_j in accurate_peak_positions[j]:
            distance = abs(pos_i - pos_j)
            min_peak_distance = min(min_peak_distance, distance)
    
    # 将距离从nm转换为点数
    min_peak_distance_in_points = min_peak_distance / (x_values[-1] - x_values[0]) * len(x_values)
    
    # 应用莱利判据
    is_resolved_by_rayleigh = min_peak_distance_in_points > (rayleigh_criterion * estimated_linewidth)
```

其中`rayleigh_criterion`是一个可调系数，默认为0.8。

### 4.5 峰值对比度评估

评估两个模式的主峰对比度，现在使用精确估计的峰值高度：

```python
if accurate_peak_heights[i] and accurate_peak_heights[j]:
    height_i = accurate_peak_heights[i][0]  # 使用最强峰的精确高度
    height_j = accurate_peak_heights[j][0]
    contrast_ratio = min(height_i, height_j) / max(height_i, height_j)
```

对比度过低的模式在实际测量中难以区分。

### 4.6 综合判据

结合上述三个标准，只有当所有标准都满足时，才认为一组模式是可分辨的：

```python
if (overlap > overlap_threshold or 
    not is_resolved_by_rayleigh or 
    contrast_ratio < 0.3):
    is_distinguishable = False
```

### 4.7 最大模式数确定

通过逐个增加模式数，检查每组模式是否满足可分辨条件，直到找到最大的可分辨模式数：

```python
for num_modes in range(2, self.l_max + 2):
    is_distinguishable = True
    
    # 检查所有模式对
    for i in range(num_modes - 1):
        for j in range(i + 1, num_modes):
            # 进行三项测试...
    
    if not is_distinguishable:
        break
        
    max_distinguishable = num_modes
```

## 5. OAM模式空间分布可视化

### 5.1 强度分布计算

OAM模式的强度分布基于Laguerre-Gaussian模式计算：

```python
# 归一化半径
rho = R / beam_waist

# 计算广义拉盖尔多项式
laguerre = eval_genlaguerre(p, abs(l), 2*(rho**2))

# 计算场分布
field = np.sqrt(2/np.pi) * np.exp(-rho**2) * rho**abs(l) * laguerre * np.exp(1j*l*Theta)
intensity = np.abs(field)**2
```

### 5.2 相位分布计算

相位分布展示了OAM模式特有的螺旋波前：

```python
phase = np.angle(field)
```

在极坐标中呈现为角度的线性函数，显示为颜色环绕的图案。OAM指数l决定了一个周期内有多少个2π相位变化。

## 6. 腔稳定性判断

FP腔的稳定性条件为：0 ≤ g₁g₂ ≤ 1，软件会对输入参数进行验证：

```python
if not (0 <= g1*g2 <= 1):
    QMessageBox.warning(self, "参数错误", "腔参数不满足稳定条件: 0 ≤ g1*g2 ≤ 1")
    return
```

只有在腔稳定的情况下，才会进行后续计算。

## 7. 高反射率FP腔的特殊处理

### 7.1 高反射率下的峰值丢失问题

当FP腔的反射率极高（如R > 0.99）时，会出现以下问题：

1. **极窄的共振峰**：高反射率导致精细度极高（可达1500以上），产生极窄的共振峰
2. **采样不足**：对于1000个计算点的分辨率，可能无法捕捉到真实的峰值
3. **峰值估计偏差**：由于采样点不足，检测到的峰值高度可能远低于理论值
4. **不同模式峰值不一致**：不同OAM模式的峰值位置略有偏移，导致采样偏差不同，产生错误的峰值高度差异

这些问题在理论上不应该出现，因为在理想的FP腔中，不同OAM模式的最大透射率应该接近相同（约为1）。

### 7.2 插值解决方案

为了解决高反射率下的峰值估计问题，软件采用了插值计算法：

1. **洛伦兹函数拟合**：选取峰值附近的点，使用洛伦兹函数进行曲线拟合
   ```
   T(x) = A * γ² / ((x - x₀)² + γ²)
   ```
   其中A是振幅，x₀是中心位置，γ是谱线半宽

2. **可视化辅助**：在高反射率条件下，图表中会显示估计的真实峰值位置和高度
   ```python
   if r1 > 0.99 and r2 > 0.99:
       # 对显示范围内的数据执行峰值检测
       peaks, _ = find_peaks(y_display, height=0.3, prominence=0.05)
       
       for peak_idx in peaks:
           # 使用插值方法估计真实峰值
           true_amplitude, true_position = self.estimate_true_peak(
               self.cavity_lengths, self.transmissions[l], full_idx)
           
           # 绘制真实峰值点
           ax.plot(true_position, true_amplitude, 'o', 
                 color=colors[l], markersize=4)
   ```

3. **模式分辨率评估**：在评估理论可分辨最大模式数时，使用插值计算的精确峰值，提高评估准确性

这种插值计算方法能在不显著增加计算负担的情况下，大幅提高高反射率FP腔透射率计算的准确性，为用户提供更可靠的模拟结果。

## 总结

Fabry-Pérot腔OAM模式分析软件基于经典的光学理论，结合现代计算方法，提供了强大的FP腔性能分析和OAM模式研究工具。软件通过计算关键物理量、模拟透射率曲线、评估模式分辨能力和可视化OAM模式分布，为光学研究和工程应用提供了理论指导。插值计算法的引入进一步提高了高反射率条件下的计算精度，解决了采样不足导致的峰值估计偏差问题。 